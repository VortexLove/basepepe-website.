<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Preventa PBJ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    input, button { padding: 10px; font-size: 16px; margin: 10px; }
  </style>
</head>
<body>
  <h2>Comprar PepeBlackJack (PBJ)</h2>
  <button onclick="switchToBase()">Cambiar a Base</button>
  <button onclick="connectWallet()">Conectar Wallet</button><br>
  <input type="number" id="ethAmount" step="0.01" placeholder="ETH (0.01 - 2)" min="0.01" max="2"><br>
  <button id="buyButton" onclick="buyPBJ()" disabled>Comprar Tokens</button>
  <p id="status"></p>

  <script>
    window.onload = function () {
      const contractAddress = "0x1EfBF9BaD1419c6DE7a0BF28158f563FafC7ab56";
      const abi = [
        "function buyTokens() payable",
        "function presaleActive() view returns (bool)",
        "function presaleEnd() view returns (uint256)"
      ];

      var provider, signer, contract;

      async function switchToBase() {
        if (!window.ethereum) {
          alert("MetaMask no detectado.");
          return;
        }
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x2105' }]
          });
          document.getElementById("status").innerText = "Red cambiada a Base.";
        } catch (err) {
          if (err.code === 4902) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: '0x2105',
                  chainName: 'Base Mainnet',
                  nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                  rpcUrls: ['https://mainnet.base.org'],
                  blockExplorerUrls: ['https://basescan.org']
                }]
              });
              document.getElementById("status").innerText = "Red Base añadida y seleccionada.";
            } catch (addError) {
              document.getElementById("status").innerText = "Error al añadir red: " + addError.message;
            }
          } else {
            document.getElementById("status").innerText = "Error al cambiar red: " + err.message;
          }
        }
      }

      window.connectWallet = async function () {
        if (!window.ethereum) {
          alert("Instala MetaMask para continuar.");
          return;
        }
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          if (!accounts.length) throw new Error("No se detectaron cuentas");

          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);

          // Tomamos la dirección directamente sin resolver ENS
          const address = accounts[0];

          document.getElementById("status").innerText = "Conectado: " + address;
          document.getElementById("buyButton").disabled = false;
        } catch (err) {
          document.getElementById("status").innerText = "Error: " + err.message;
        }
      };

      window.buyPBJ = async function () {
        const ethValue = parseFloat(document.getElementById("ethAmount").value);
        if (!ethValue || ethValue < 0.01 || ethValue > 2) {
          alert("Ingresa un valor entre 0.01 y 2 ETH.");
          return;
        }

        if (!contract) {
          alert("Conecta la wallet primero.");
          return;
        }

        try {
          const active = await contract.presaleActive();
          const end = await contract.presaleEnd();
          const now = Math.floor(Date.now() / 1000);

          if (!active || now > end) {
            document.getElementById("status").innerText = "La preventa ha finalizado.";
            return;
          }

          const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethValue.toString()) });
          document.getElementById("status").innerText = "Transacción enviada...";
          await tx.wait();
          document.getElementById("status").innerText = "¡Compra realizada con éxito!";
        } catch (err) {
          console.error(err);
          document.getElementById("status").innerText = "Error: " + (err?.reason || err.message);
        }
      };
    };
  </script>
</body>
</html>
