<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pepe Blackjack (PBJ) - DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="./cdn.tailwindcss.js"></script>
    <!-- tsParticles para fondo animado -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <!-- Pixel Art Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
      html, body, * {
        font-family: 'Press Start 2P', cursive !important;
      }
      /* Quita flechas de inputs number */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      #tsparticles {
        position: fixed;
        z-index: -1;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
      .card {
        position: relative;
        width: 120px;
        height: 160px;
        background: white;
        border: 2px solid #222;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }
      .card.deal {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .card .corner {
        position: absolute;
        font-size: 0.8rem;
      }
      .card .top-left {
        top: 4px;
        left: 6px;
      }
      .card .bottom-right {
        bottom: 4px;
        right: 6px;
        transform: rotate(180deg);
      }
      .red-suit { color: red; }
      .black-suit { color: black; }
      .form-presale.input {
          width: 70%;
      }
      .w-100 {
        width: 100%;
      }
      .top-45 {
        top: 10.5rem;
      }
      .bottom-45 {
        bottom: 10.5rem;
      }
      .image-pepe-preventa {
        height: 25rem;
        width: auto;
        margin-right: auto;
        margin-left: auto;
      }
      @media (max-width: 500px) {
        .cartas-blackjack {
          height: 25rem !important;
        }
      }
    </style>
  </head>
  <body class="bg-gray-950 text-white min-h-screen">
    <div id="tsparticles"></div>
    <div class="max-w-4xl mx-auto p-4 space-y-8">

      <!-- Header -->
      <header class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700">
        <h1 class="text-2xl sm:text-3xl font-bold text-green-400 mb-4 md:mb-0">Pepe Blackjack (PBJ)</h1>
        <button
          id="connectButton"
          class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded text-white w-full sm:w-auto text-center"
        >Conectar Wallet</button>
        
        <div id="pbjDisplay" style="display: flex; align-items: center; gap: 8px; font-family: 'Press Start 2P', cursive; font-size: 20px; color: #39ff14; background: transparent; padding: 10px 20px; border: none; border-radius: 8px; box-shadow: none;">
  <img src="./Coin.png" alt="PBJ Coin" width="48" height="48" style="image-rendering: pixelated; border-radius: 50%; border: none;">
  <span id="pbjBalanceHeader">0</span> PBJ
</div>
        
      </header>
      <div id="status" class="text-center text-base sm:text-lg"></div>


      <img
      src="./preventa.png"
      alt="preventa"
      class="image-pepe-preventa rounded-lg border-0 border-gray-700 shadow-inner"
    />
    

      <!-- Componente de Compra -->
      <section class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full sm:max-w-md mx-auto">
        <h2 class="text-xl sm:text-2xl font-semibold text-green-400 mb-6">Compra de Tokens</h2>

        <!-- Saldo -->
        <div class="flex justify-between text-xs sm:text-sm text-gray-400 mb-4">
          <span>Saldo de ETH</span>
          <span id="ethBalance" class="font-mono text-white">0.0000 ETH</span>
        </div>

        <!-- Inputs -->
        <div class="space-y-4 mb-6 form-presale">
          <!-- ETH ‚Üí PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="ethAmount"
              min="0.01"
              step="0.0001"
              value="0.01"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0.0 ETH"
            />
            <span class="text-gray-300 font-medium text-sm">ETH</span>
          </div>

          <!-- Flecha SVG -->
          <div class="flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- PBJ -->
          <div class="flex items-center space-x-2">
            <input
              type="number"
              id="pbjAmount"
              min="10000"
              step="10000"
              value="10000"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm"
              placeholder="0 PBJ"
            />
            <span class="text-gray-300 font-medium text-sm">PBJ</span>
          </div>
        </div>

        <!-- Bot√≥n principal -->
        <button
          id="buyButton"
          disabled
          class="w-full py-2 sm:py-3 rounded-lg bg-gradient-to-r from-green-500 to-green-700 text-white font-semibold hover:from-green-600 hover:to-green-800 disabled:opacity-50 text-sm sm:text-base"
        >Comprar</button>
      </section>

      <!-- Juego Blackjack -->
      <section id="blackjackGame" class="bg-gray-900 p-4 sm:p-6 rounded-xl shadow-xl">
        <h2 class="text-xl sm:text-2xl font-bold text-green-400 mb-4">üÉè Juego de Blackjack</h2>
        <div class="mb-4 text-xs sm:text-sm flex flex-col sm:flex-row sm:items-center sm:space-x-8 space-y-2 sm:space-y-0">
       <div class="flex items-center space-x-2">
  <div class="text-xs text-green-400" style="font-family: 'Press Start 2P', cursive;">
    Saldo: <span id="pbjBalanceGame">0</span> PBJ
  </div>
  <label for="betAmount" class="text-sm ml-4">Apuesta:</label>
  <input
    type="number"
    id="betAmount"
    min="1"
    step="1"
    value="1000"
    class="w-20 px-2 py-1 rounded bg-gray-800 text-white text-sm"
  />
</div>
        </div>

        <div class="relative h-64 sm:h-96 cartas-blackjack mb-4">
          <div id="dealerArea" class="absolute top-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"></div>
          <div class="absolute top-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center">
            Crupier Puntos: <span id="dealerScore">0</span>
          </div>

          <div id="playerArea" class="absolute bottom-0 left-1/2 transform -translate-x-1/2 flex space-x-2 sm:space-x-3 overflow-x-auto"></div>
          <div class="absolute bottom-45 w-100 left-1/2 transform -translate-x-1/2 text-xs sm:text-sm text-center">
            Jugador Puntos: <span id="playerScore">0</span>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
          <button id="dealBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded flex-1">Repartir</button>
          <button id="hitBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>Pedir</button>
          <button id="standBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded flex-1" disabled>Plantarse</button>
        </div>

        <div id="resultMsg" class="mt-4 text-base sm:text-lg font-semibold text-center"></div>
      </section>

      <!-- Lore -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <!-- Imagen -->
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <!-- Aseg√∫rate de que Carta.png est√© junto a este HTML -->
    <img
      src="./carta.png"
      alt="Carta de BasePepe"
      class="w-full h-auto rounded-lg border-0 border-gray-700 shadow-inner"
    />
  </div>

  <!-- Texto -->
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Lore</h2>
    <p class="text-gray-300 leading-relaxed text-sm sm:text-base">
      Pepe Blackjack (PBJ) surge de la legendaria mesa de las ranas del ciber-casino.
      Este token mezcla el humor meme con la emoci√≥n del blackjack, ofreciendo una
      experiencia √∫nica de riesgo y recompensa en la Blockchain de Base.
    </p>
  </div>
</section>

      <!-- Roadmap -->
<section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <!-- Imagen -->
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <!-- Aseg√∫rate de que Carta.png est√© junto a este HTML -->
    <img
      src="./logo.png"
      alt="logo"
      class="w-full h-auto rounded-lg border-2 border-gray-700 shadow-inner"
    />
  </div>

  <!-- Texto -->
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Roadmap</h2>
    <p class="text-gray-300 leading-relaxed text-sm sm:text-base">
          <li><strong>Q2 2025:</strong> Preventa PBJ en Base y lanzamiento oficial.</li>
          <li><strong>Q3 2025:</strong> Listado en DEX, funcionalidades de staking.</li>
          <li><strong>Q4 2025:</strong> Plataforma de Blackjack Web3 con integraci√≥n NFT.</li>
          <li><strong>Q1 2026:</strong> Expansi√≥n metaverso y recompensas para holders.</li>
    </p>
  </div>
</section>

      <!-- Tokenomics -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl flex flex-col md:flex-row items-center">
  <!-- Imagen -->
  <div class="w-full md:w-1/3 mb-4 md:mb-0">
    <!-- Aseg√∫rate de que Carta.png est√© junto a este HTML -->
    <img
      src="./pepe_crupier.png"
      alt="pepe"
      class="w-full h-auto rounded-lg border-2 border-gray-700 shadow-inner"
    />
  </div>

  <!-- Texto -->
  <div class="w-full md:w-2/3 md:pl-6">
    <h2 class="text-2xl font-bold text-green-400 mb-4">üìñ Tokenomics</h2>
    <ul class="text-gray-300 space-y-1">
          <li><strong>S√≠mbolo:</strong> PBJ</li>
          <li><strong>Red:</strong> Base</li>
          <li><strong>Supply total:</strong> 1,000,000,000 PBJ</li>
          <li><strong>Precio (Preventa):</strong> 1 ETH = 1,000,000 PBJ</li>
          <li><strong>Contrato:</strong> <a href="https://basescan.org/address/0x3Bcc79d679d900b78684F44FF7DacC286fAb0C57" class="text-blue-400 underline" target="_blank">0x3Bcc...0C57</a></li>
        </ul>
  </div>
</section>

      <!-- Equipo y Enlaces -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">üë• Equipo y Enlaces</h2>
        <ul class="text-gray-300 space-y-2">
          <li><strong>Equipo:</strong> Vortex (Desarrollo), John Smith (Marketing), CryptoFrogDAO (Comunidad)</li>
          <li><strong>Sitio oficial:</strong> <a href="#" class="text-blue-400 underline">www.pepeblackjack.online</a></li>
          <li><strong>Twitter:</strong> <a href="https://twitter.com/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a></li>
          <li><strong>Telegram:</strong> <a href="https://t.me/pepeblackjack21" class="text-blue-400 underline">@pepeblackjack21</a></li>
        </ul>
      </section>

      <!-- FAQ -->
      <section class="bg-gray-900 p-6 rounded-xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-400 mb-4">‚ùì FAQ</h2>
        <div class="text-gray-300 space-y-4">
          <div>
            <h3 class="font-semibold">¬øC√≥mo compro PBJ?</h3>
            <p>Conecta tu wallet, ingresa la cantidad en ETH o PBJ y presiona "Comprar".</p>
          </div>
          <div>
            <h3 class="font-semibold">¬øQu√© sucede cuando finaliza la preventa?</h3>
            <p>La funci√≥n <code>endPresale()</code> desactiva las compras; solo podr√°s intercambiar en DEX posteriormente.</p>
          </div>
        </div>
      </section>


      </div>
    </div>

    <script>
      tsParticles.load("tsparticles", {
        background: { color: { value: "#000" } },
        fpsLimit: 60,
        interactivity: {
          events: { onHover: { enable: true, mode: "repulse" }, resize: true },
          modes: { repulse: { distance: 100, duration: 0.4 } }
        },
        particles: {
          color: { value: "#00ff99" },
          links: { enable: true, color: "#00ff99", distance: 150 },
          move: { enable: true, speed: 2 },
          number: { value: 60 },
          opacity: { value: 0.5 },
          shape: { type: "circle" },
          size: { value: { min: 1, max: 3 } }
        },
        detectRetina: true
      });
    </script>
    <script>
  async function updatePBJBalance() {
    if (!pbjContract || !userAddress) return;
    try {
      const headerSpan = document.getElementById('pbjBalanceHeader');
      const gameSpan   = document.getElementById('pbjBalanceGame');
      const raw     = await pbjContract.balanceOf(userAddress);
      const dec     = await pbjContract.decimals();
      const balance = ethers.utils.formatUnits(raw, dec);
      const formatted = parseFloat(balance).toFixed(2);
      if (headerSpan) headerSpan.innerText = formatted;
      if (gameSpan)   gameSpan.innerText   = formatted;
    } catch (err) {
      console.error("Error al obtener PBJ balance:", err);
    }
  }

  const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'], vals = [2,3,4,5,6,7,8,9,10,'J','Q','K','A'];
  let deck = [], dealerHand = [], playerHand = [];

  function shuffle() {
    deck = [];
    suits.forEach(s => vals.forEach(v => deck.push({s,v})));
    deck.sort(() => Math.random() - 0.5);
  }

  function dealCard(hand, area, index) {
    const card = deck.pop();
    hand.push(card);
    const isRed = card.s === '‚ô•' || card.s === '‚ô¶';
    const el = document.createElement('div');
    el.className = `card ${isRed ? 'red-suit' : 'black-suit'}`;
    el.innerHTML = `
      <div class="corner top-left">${card.v}${card.s}</div>
      <div class="corner bottom-right">${card.v}${card.s}</div>
      ${card.v}${card.s}
    `;
    area.appendChild(el);
    setTimeout(() => el.classList.add('deal'), index * 150);
  }

  function calc(hand) {
    let sum = 0, aces = 0;
    hand.forEach(c => {
      if (c.v === 'A') { aces++; sum += 11; }
      else if (['J','Q','K'].includes(c.v)) sum += 10;
      else sum += c.v;
    });
    while (sum > 21 && aces) { sum -= 10; aces--; }
    return sum;
  }

  function updateScores() {
    const p = calc(playerHand);
    const d = calc(dealerHand);
    document.getElementById('playerScore').innerText = p;
    document.getElementById('dealerScore').innerText = d;
    if (p > 21) {
      document.getElementById('resultMsg').innerText = 'Has perdido';
      document.getElementById('hitBtn').disabled = true;
      document.getElementById('standBtn').disabled = true;
    }
  }

  document.getElementById('dealBtn').onclick = async () => {
    const bet = parseInt(document.getElementById('betAmount').value) || 0;

    try {
      const decimals = await pbjContract.decimals();
      const betUnits = ethers.utils.parseUnits(bet.toString(), decimals);
      const rawBalance = await pbjContract.balanceOf(userAddress);
      const balance = parseFloat(ethers.utils.formatUnits(rawBalance, decimals));

      if (bet > balance) {
        alert('Saldo insuficiente');
        return;
      }

      // 1. Aprobar el gasto de PBJ
      const txApprove = await pbjContract.connect(signer).approve(casinoContract.address, betUnits);
      await txApprove.wait();

      // 2. Colocar la apuesta en el contrato
      const txPlace = await casinoContract.placeBet(betUnits);
      await txPlace.wait();

      // 3. Repartir cartas en UI
      shuffle(); dealerHand = []; playerHand = [];
      const dArea = document.getElementById('dealerArea'),
            pArea = document.getElementById('playerArea');
      dArea.innerHTML = ''; pArea.innerHTML = '';
      dealCard(dealerHand, dArea, 0);
      dealCard(playerHand, pArea, 1);
      dealCard(playerHand, pArea, 2);
      setTimeout(updateScores, 500);

      document.getElementById('hitBtn').disabled = false;
      document.getElementById('standBtn').disabled = false;
      document.getElementById('resultMsg').innerText = '';
    } catch (err) {
      console.error("Error al colocar la apuesta:", err);
      alert("No se pudo colocar la apuesta: " + (err.data?.message || err.message));
    }
  };

  document.getElementById('hitBtn').onclick = () => {
    dealCard(playerHand, document.getElementById('playerArea'), playerHand.length);
    setTimeout(() => {
      updateScores();
      if (calc(playerHand) > 21) {
        document.getElementById('hitBtn').disabled = true;
        document.getElementById('standBtn').disabled = true;
      }
    }, 500);
  };

  document.getElementById('standBtn').onclick = async () => {
    const interval = setInterval(async () => {
      if (calc(dealerHand) < 17) {
        dealCard(dealerHand, document.getElementById('dealerArea'), dealerHand.length);
        setTimeout(updateScores, 500);
      } else {
        clearInterval(interval);
        const p = calc(playerHand), d = calc(dealerHand);
        let msg = 'Empate';
        let playerWon = false;
        let isDraw = false;

        if (p <= 21 && (d > 21 || p > d)) {
          msg = '¬°Ganaste!';
          playerWon = true;
        } else if (p === d && p <= 21) {
          msg = 'Empate';
          isDraw = true;
        } else {
          msg = 'Has perdido';
        }

        document.getElementById('resultMsg').innerText = msg;

        try {
          const txResolve = await casinoContract.connect(signer).resolveBet(playerWon, isDraw);
          await txResolve.wait();
          updatePBJBalance();
        } catch (err) {
          console.error("Error al resolver la apuesta:", err);
          alert("Error al resolver la apuesta on-chain.");
        }
      }
    }, 600);
  };
</script>
<script>
  const contractAddress = '0x514963d1deb56ec8aFc212209299A807871A6098'; // contrato de preventa
  const pbjContractAddress = '0x514963d1deb56ec8aFc212209299A807871A6098'; // contrato del token
  const rate = 1000000;
  const abi = ['function buyTokens() payable'];
  const pbjAbi = [
  'function balanceOf(address) view returns (uint256)',
  'function decimals() view returns (uint8)'
];

  let provider, signer, contract, pbjContract, casinoContract, userAddress;

  const connectButton = document.getElementById('connectButton');
  const buyButton = document.getElementById('buyButton');
  const statusDiv = document.getElementById('status');
  const ethAmountInput = document.getElementById('ethAmount');
  const pbjAmountInput = document.getElementById('pbjAmount');
  const ethBalanceSpan = document.getElementById('ethBalance');

  function updateEstimate() {
    const ethVal = parseFloat(ethAmountInput.value) || 0;
    const pbjVal = parseFloat(pbjAmountInput.value) || 0;
    if (document.activeElement === ethAmountInput) {
      pbjAmountInput.value = (ethVal * rate).toFixed(0);
    } else {
      ethAmountInput.value = (pbjVal / rate).toFixed(6);
    }
  }

  ethAmountInput.addEventListener('input', updateEstimate);
  pbjAmountInput.addEventListener('input', updateEstimate);

  connectButton.addEventListener('click', async () => {
    if (!window.ethereum) {
      statusDiv.innerText = '‚ùå MetaMask no detectado';
      alert('MetaMask no detectado');
      return;
    }

    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, signer);
      pbjContract = new ethers.Contract(pbjContractAddress, pbjAbi, provider);
      userAddress = await signer.getAddress();

      const network = await provider.getNetwork();
      if (network.chainId !== 8453) {
        statusDiv.innerText = '‚ùå Con√©ctate a la red Base';
        alert('Por favor cambia a la red Base en MetaMask.');
        return;
      }

      const balance = await provider.getBalance(userAddress);
      ethBalanceSpan.innerText = `${parseFloat(ethers.utils.formatEther(balance)).toFixed(4)} ETH`;
      statusDiv.innerText = '‚úÖ Wallet conectada';
      buyButton.disabled = false;

      updatePBJBalance();
      
      // 1Ô∏è‚É£ Instancia del contrato ‚Äúcasino‚Äù
const casinoAbi = [
  'function placeBet(uint256 amount) external',
  'function resolveBet(bool playerWon, bool isDraw) external',
];
casinoContract = new ethers.Contract(
  '0x67C6a3208C0be081f13BDc387bA1Bd4f6C697f12', // tu PepeBlackjackGame
  casinoAbi,
  signer
);

    } catch (err) {
      console.error(err);
      statusDiv.innerText = '‚ùå Error: ' + err.message;
    }
  });

  buyButton.addEventListener('click', async () => {
    if (!contract) {
      statusDiv.innerText = '‚ùå Primero conecta la wallet';
      alert('Conecta tu wallet primero');
      return;
    }

    const ethVal = parseFloat(ethAmountInput.value);
    if (isNaN(ethVal) || ethVal <= 0) {
      alert('Ingresa una cantidad v√°lida de ETH');
      return;
    }

    if (ethVal > 2) {
      alert('El m√°ximo de compra es 2 ETH por wallet');
      return;
    }

    try {
      const value = ethers.utils.parseEther(ethVal.toString());
      statusDiv.innerText = '‚åõ Confirmar en MetaMask...';
      buyButton.disabled = true;

      const tx = await contract.buyTokens({ value });
      statusDiv.innerText = `üì® Tx enviada: ${tx.hash.slice(0,10)}...`;
      await tx.wait();

      statusDiv.innerText = '‚úÖ Compra exitosa';
      alert('¬°Tokens comprados con √©xito!');
      updatePBJBalance();
    } catch (e) {
      console.error(e);
      statusDiv.innerText = '‚ùå ' + (e.data?.message || e.message);
      alert('Error en la compra: ' + (e.data?.message || e.message));
    } finally {
      buyButton.disabled = false;
    }
  });

  ethAmountInput.dispatchEvent(new Event('input'));
</script>
  </body>
</html>
