<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Preventa PBJ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    input, button { padding: 10px; font-size: 16px; margin: 10px; }
  </style>
</head>
<body>
  <h2>Comprar PepeBlackJack (PBJ)</h2>
  <button onclick="switchToBase()">Cambiar a Base</button>
  <button onclick="connectWallet()">Conectar Wallet</button><br>
  <input type="number" id="ethAmount" step="0.01" placeholder="ETH (0.01 - 2)" min="0.01" max="2"><br>
  <button id="buyButton" onclick="buyPBJ()" disabled>Comprar Tokens</button>
  <p id="status"></p>

  <script>
    window.onload = function () {
      const contractAddress = "REEMPLAZAR_CON_TU_CONTRATO";
      const abi = [
        "function buyTokens() payable",
        "function presaleActive() view returns (bool)",
        "function presaleEnd() view returns (uint256)"
      ];

      var provider, signer, contract;

      async function switchToBase() {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x2105' }]
          });
        } catch (err) {
          if (err.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x2105',
                chainName: 'Base Mainnet',
                nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
                rpcUrls: ['https://mainnet.base.org'],
                blockExplorerUrls: ['https://basescan.org']
              }]
            });
          } else {
            document.getElementById("status").innerText = "Error al cambiar de red: " + err.message;
          }
        }
      }

      window.connectWallet = async function () {
        if (window.ethereum) {
          try {
            await window.ethereum.request({ method: "eth_requestAccounts" });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(contractAddress, abi, signer);
            const address = await signer.getAddress();
            document.getElementById("status").innerText = "Conectado: " + address;
            document.getElementById("buyButton").disabled = false;
          } catch (err) {
            document.getElementById("status").innerText = "Error: " + err.message;
          }
        } else {
          alert("Instala MetaMask para continuar.");
        }
      };

      window.buyPBJ = async function () {
        const ethValue = parseFloat(document.getElementById("ethAmount").value);
        if (!ethValue || ethValue < 0.01 || ethValue > 2) {
          alert("Ingresa entre 0.01 y 2 ETH.");
          return;
        }

        if (!contract) {
          alert("Conecta la wallet primero.");
          return;
        }

        try {
          const active = await contract.presaleActive();
          const end = await contract.presaleEnd();
          const now = Math.floor(Date.now() / 1000);

          if (!active || now > end) {
            document.getElementById("status").innerText = "La preventa ha finalizado.";
            return;
          }

          const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethValue.toString()) });
          document.getElementById("status").innerText = "Transacción enviada...";
          await tx.wait();
          document.getElementById("status").innerText = "¡Compra realizada con éxito!";
        } catch (err) {
          console.error(err);
          document.getElementById("status").innerText = "Error: " + (err?.reason || err.message);
        }
      };
    };
  </script>
</body>
</html>
