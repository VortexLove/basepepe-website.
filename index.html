<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compra de Tokens PBJ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: auto; padding: 20px; }
    input { width: 100%; padding: 8px; margin: 6px 0; font-size: 1em; }
    button { padding: 10px; font-size: 1em; width: 100%; }
    .section { margin-top: 20px; }
    .label { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Compra de Tokens PBJ</h2>

  <button id="connectButton">Conectar MetaMask</button>
  <div id="status" class="section"></div>

  <div class="section" id="balances" style="display:none;">
    <div><strong>Tu saldo:</strong></div>
    <div>ETH: <span id="ethBalance">-</span></div>
    <div>PBJ: <span id="pbjBalance">-</span></div>
  </div>

  <div class="section">
    <label class="label">Cantidad en ETH (0.01 - 2):</label>
    <input type="number" id="ethInput" min="0.000000000000000001" max="2" step="0.000000000000000001" />

    <label class="label">Cantidad en PBJ:</label>
    <input type="number" id="pbjInput" min="10000" step="10000" />

    <button id="buyButton" disabled>Comprar Tokens</button>
  </div>

  <script>
    const contractAddress = '0x3Bcc79d679d900b78684F44FF7DacC286fAb0C57';
    const abi = [
      'function buyTokens() payable',
      'function balanceOf(address) view returns (uint256)',
      'function decimals() view returns (uint8)'
    ];

    const tokenRate = 1_000_000; // 1 ETH = 1,000,000 PBJ
    let provider, signer, contract, userAddress;

    const connectButton = document.getElementById('connectButton');
    const buyButton = document.getElementById('buyButton');
    const statusDiv = document.getElementById('status');
    const ethInput = document.getElementById('ethInput');
    const pbjInput = document.getElementById('pbjInput');
    const ethBalanceSpan = document.getElementById('ethBalance');
    const pbjBalanceSpan = document.getElementById('pbjBalance');
    const balancesDiv = document.getElementById('balances');

    connectButton.onclick = async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send('eth_requestAccounts', []);
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          contract = new ethers.Contract(contractAddress, abi, signer);

          statusDiv.innerText = 'MetaMask conectado âœ…';
          buyButton.disabled = false;
          balancesDiv.style.display = 'block';

          updateBalances();
        } catch (err) {
          statusDiv.innerText = 'Error al conectar MetaMask: ' + err.message;
        }
      } else {
        statusDiv.innerText = 'MetaMask no detectado.';
      }
    };

    async function updateBalances() {
      const ethBalance = await provider.getBalance(userAddress);
      ethBalanceSpan.innerText = ethers.utils.formatEther(ethBalance);

      const pbjBalance = await contract.balanceOf(userAddress);
      pbjBalanceSpan.innerText = ethers.utils.formatUnits(pbjBalance, 18);
    }

    // ETH to PBJ
    ethInput.oninput = () => {
      const ethValue = parseFloat(ethInput.value);
      pbjInput.value = ethValue > 0 ? ethValue * tokenRate : '';
    };

    // PBJ to ETH
    pbjInput.oninput = () => {
      const pbjValue = parseFloat(pbjInput.value);
      ethInput.value = pbjValue > 0 ? pbjValue / tokenRate : '';
    };

    buyButton.onclick = async () => {
      if (!contract) {
        statusDiv.innerText = 'Primero conecta MetaMask.';
        return;
      }

      try {
        const ethAmount = parseFloat(ethInput.value);
        if (isNaN(ethAmount) || ethAmount < 0.000000000000000001 || ethAmount > 2) {
          statusDiv.innerText = 'El monto debe estar entre 0.000000000000000001 y 2 ETH';
          return;
        }

        const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethAmount.toString()) });
        statusDiv.innerText = 'Esperando confirmaciÃ³n de la transacciÃ³n...';
        await tx.wait();
        statusDiv.innerText = 'Compra exitosa ðŸŽ‰ TxHash: ' + tx.hash;

        updateBalances();
      } catch (err) {
        console.error(err);
        const msg = err.data?.message || err.message || 'Error desconocido';
        statusDiv.innerText = 'Error al comprar tokens: ' + msg;
      }
    };
  </script>
</body>
</html>
