<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compra de Tokens PBJ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Compra de Tokens PBJ</h1>
  <button id="connectButton">Conectar MetaMask</button>
  <div id="status"></div>
  <div>
    <label for="ethAmount">Cantidad de ETH:</label>
    <input type="number" id="ethAmount" min="0.01" max="2" step="0.01" value="0.01">
    <button id="buyButton" disabled>Comprar Tokens</button>
  </div>

  <script>
    const contractAddress = '0x1EfBF9BaD1419c6DE7a0BF28158f563FafC7ab56';
    const abi = [
      'function buyTokens() payable',
      'function presaleActive() view returns (bool)',
      'function presaleEnd() view returns (uint256)',
      'function rate() view returns (uint256)',
      'function minBuy() view returns (uint256)',
      'function maxBuy() view returns (uint256)'
    ];

    let provider;
    let signer;
    let contract;

    document.getElementById('connectButton').addEventListener('click', async () => {
      if (typeof window.ethereum !== 'undefined') {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, abi, signer);
        document.getElementById('status').innerText = 'Conectado a MetaMask';
        document.getElementById('buyButton').disabled = false;
      } else {
        document.getElementById('status').innerText = 'MetaMask no detectado';
      }
    });

    document.getElementById('buyButton').addEventListener('click', async () => {
      const ethAmount = parseFloat(document.getElementById('ethAmount').value);
      const minBuy = await contract.minBuy();
      const maxBuy = await contract.maxBuy();
      const rate = await contract.rate();
      const presaleActive = await contract.presaleActive();
      const presaleEnd = await contract.presaleEnd();

      if (!presaleActive) {
        alert('La preventa ha finalizado');
        return;
      }

      if (Date.now() / 1000 > presaleEnd) {
        alert('La preventa ha terminado');
        return;
      }

      if (ethAmount < ethers.utils.formatEther(minBuy)) {
        alert('La cantidad mínima de compra es ' + ethers.utils.formatEther(minBuy) + ' ETH');
        return;
      }

      if (ethAmount > ethers.utils.formatEther(maxBuy)) {
        alert('La cantidad máxima de compra es ' + ethers.utils.formatEther(maxBuy) + ' ETH');
        return;
      }

      const tokenAmount = ethers.utils.parseUnits((ethAmount * rate).toString(), 18);
      const tx = await contract.buyTokens({
        value: ethers.utils.parseEther(ethAmount.toString())
      });

      document.getElementById('status').innerText = 'Transacción enviada: ' + tx.hash;
      await tx.wait();
      document.getElementById('status').innerText = 'Compra exitosa: ' + tx.hash;
    });
  </script>
</body>
</html>
