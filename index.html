<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compra de Tokens PBJ</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Compra de Tokens PBJ</h1>

  <button id="connectButton">Conectar MetaMask</button>
  <div id="status" style="margin: 10px 0; font-weight: bold;"></div>

  <div>
    <label for="ethAmount">Cantidad de ETH (0.01 - 2):</label>
    <input
      type="number"
      id="ethAmount"
      min="0.01"
      max="2"
      step="0.01"
      value="0.01"
      style="width: 80px;"
    />
    <button id="buyButton" disabled>Comprar Tokens</button>
  </div>

  <script>
    const contractAddress = '0x3Bcc79d679d900b78684F44FF7DacC286fAb0C57';
    const abi = [
      'function buyTokens() payable'
    ];

    let provider;
    let signer;
    let contract;

    const connectButton = document.getElementById('connectButton');
    const buyButton = document.getElementById('buyButton');
    const statusDiv = document.getElementById('status');
    const ethAmountInput = document.getElementById('ethAmount');

    connectButton.onclick = async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send('eth_requestAccounts', []);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);
          statusDiv.innerText = 'MetaMask conectado âœ…';
          buyButton.disabled = false;
        } catch (error) {
          statusDiv.innerText = 'Error al conectar MetaMask: ' + error.message;
        }
      } else {
        statusDiv.innerText = 'MetaMask no detectado. Por favor, instala MetaMask.';
      }
    };

    buyButton.onclick = async () => {
      if (!contract) {
        statusDiv.innerText = 'Primero conecta la wallet.';
        return;
      }

      try {
        const ethAmount = parseFloat(ethAmountInput.value);
        if (isNaN(ethAmount) || ethAmount <= 0) {
          statusDiv.innerText = 'Introduce un valor vÃ¡lido de ETH';
          return;
        }

        const value = ethers.utils.parseEther(ethAmount.toString());

        statusDiv.innerText = 'Abre MetaMask para confirmar la transacciÃ³n...';

        const tx = await contract.buyTokens({ value });
        statusDiv.innerText = 'TransacciÃ³n enviada: ' + tx.hash;

        await tx.wait();

        statusDiv.innerText = 'Compra exitosa ðŸŽ‰ TxHash: ' + tx.hash;
      } catch (error) {
        console.error(error);
        statusDiv.innerText = 'Error: ' + (error.data?.message || error.message || 'Error desconocido');
      }
    };
  </script>
</body>
</html>
