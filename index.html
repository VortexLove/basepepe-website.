<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pepe Blackjack (PBJ) - DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Press Start 2P', cursive; }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <div class="max-w-4xl mx-auto p-4 space-y-8">
      <!-- Header -->
      <header class="flex justify-between items-center py-4 border-b border-gray-700">
        <h1 class="text-3xl font-bold text-indigo-400">Pepe Blackjack (PBJ)</h1>
        <button id="connectButton" class="bg-indigo-500 hover:bg-indigo-600 px-4 py-2 rounded">Conectar Wallet</button>
      </header>
      <div id="status" class="text-center text-xs"></div>

      <!-- Saldo y Compra -->
      <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl text-indigo-300 mb-4">üí∞ Saldo y Compra de Tokens</h2>
        <div class="flex justify-between text-sm mb-2">
          <div>ETH: <span id="ethBalance">-</span></div>
          <div>PBJ: <span id="pbjBalance">-</span></div>
        </div>
        <div class="flex gap-2 mb-4 text-sm">
          <input type="number" id="ethAmount" placeholder="ETH" min="0.01" step="0.01" class="flex-1 p-2 rounded bg-gray-700" />
          <div class="p-2 bg-gray-700 rounded flex-1 text-center" id="pbjEstimate">0 PBJ</div>
        </div>
        <button id="buyButton" disabled class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded">Comprar PBJ</button>
      </section>

      <!-- Blackjack Game -->
      <section id="blackjackGame" class="bg-gray-800 p-6 rounded-xl shadow-lg hidden">
        <h2 class="text-2xl text-indigo-300 mb-4">üÉè Juego de Blackjack</h2>
        <div class="mb-4 text-sm">Saldo PBJ: <span id="gameBalance">0</span> PBJ</div>
        <div class="flex items-center gap-2 mb-4 text-sm">
          <label>Apuesta (PBJ):</label>
          <input type="number" id="betAmount" min="10000" step="10000" class="p-2 rounded bg-gray-700 w-24" />
          <button id="betButton" class="bg-indigo-600 hover:bg-indigo-700 py-1 px-3 rounded">Apostar</button>
        </div>
        <div id="cards" class="grid grid-cols-2 gap-4 text-xs">
          <div>
            <h3 class="font-bold">Jugador</h3>
            <div id="playerCards" class="flex gap-1"></div>
            <div>Puntos: <span id="playerScore">0</span></div>
          </div>
          <div>
            <h3 class="font-bold">Crupier</h3>
            <div id="dealerCards" class="flex gap-1"></div>
            <div>Puntos: <span id="dealerScore">0</span></div>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button id="hitButton" disabled class="flex-1 bg-indigo-600 hover:bg-indigo-700 py-2 rounded">Pedir</button>
          <button id="standButton" disabled class="flex-1 bg-indigo-600 hover:bg-indigo-700 py-2 rounded">Plantarse</button>
        </div>
        <div id="gameResult" class="mt-4 text-sm"></div>
      </section>

      <!-- Resto de secciones (Lore, Roadmap, etc.) omitidas por brevedad -->
    </div>

    <script>
      // Ethers & Contract
      const contractAddr = '0x3Bcc79d679d900b78684f44ff7dacc286fab0c57';
      const tokenAbi = ['function buyTokens() payable','function balanceOf(address) view returns(uint256)'];
      const rate = 1000000;
      let provider, signer, contract;

      // UI Elements
      const connectBtn = document.getElementById('connectButton');
      const statusDiv = document.getElementById('status');
      const ethBalSpan = document.getElementById('ethBalance');
      const pbjBalSpan = document.getElementById('pbjBalance');
      const ethIn = document.getElementById('ethAmount');
      const pbjEst = document.getElementById('pbjEstimate');
      const buyBtn = document.getElementById('buyButton');
      const blackjackSec = document.getElementById('blackjackGame');
      const gameBalSpan = document.getElementById('gameBalance');
      const betIn = document.getElementById('betAmount');
      const betBtn = document.getElementById('betButton');
      const playerCardsDiv = document.getElementById('playerCards');
      const dealerCardsDiv = document.getElementById('dealerCards');
      const playerScoreSpan = document.getElementById('playerScore');
      const dealerScoreSpan = document.getElementById('dealerScore');
      const hitBtn = document.getElementById('hitButton');
      const standBtn = document.getElementById('standButton');
      const resultDiv = document.getElementById('gameResult');

      let userAddr, gameBalance;

      // Conectar Wallet
      connectBtn.onclick = async()=>{
        if(window.ethereum){
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send('eth_requestAccounts',[]);
          signer = provider.getSigner();
          userAddr = await signer.getAddress();
          contract = new ethers.Contract(contractAddr, tokenAbi, signer);
          const ethBal = await provider.getBalance(userAddr);
          const pbjBal = await contract.balanceOf(userAddr);
          ethBalSpan.innerText = `${parseFloat(ethers.utils.formatEther(ethBal)).toFixed(4)} ETH`;
          pbjBalSpan.innerText = `${ethers.utils.formatUnits(pbjBal,18)} PBJ`;
          gameBalance = parseInt(ethers.utils.formatUnits(pbjBal,18));
          gameBalSpan.innerText = gameBalance;
          statusDiv.innerText = '‚úÖ Conectado';
          buyBtn.disabled = false;
          blackjackSec.classList.remove('hidden');
        } else statusDiv.innerText = '‚ùå Instala MetaMask';
      };

      // Estimar PBJ
      ethIn.oninput = ()=>{ pbjEst.innerText = `${(parseFloat(ethIn.value)||0)*rate} PBJ`; };

      // Comprar
      buyBtn.onclick = async()=>{
        const val = ethers.utils.parseEther((parseFloat(ethIn.value)||0).toString());
        statusDiv.innerText='Confirma transacci√≥n';
        const tx = await contract.buyTokens({value:val}); await tx.wait();
        statusDiv.innerText='Compra exitosa';
      };

      // Blackjack Logic
      let deck, playerHand, dealerHand;
      function initDeck(){ deck=[]; const suits=['‚ô†','‚ô•','‚ô¶','‚ô£']; const vals=[2,3,4,5,6,7,8,9,10,'J','Q','K','A'];
        suits.forEach(s=>vals.forEach(v=>deck.push({s,v}))); deck=deck.sort(()=>Math.random()-0.5);
      }
      function score(hand){ let sum=0, aces=0; hand.forEach(c=>{ if(c.v==='A'){aces++; sum+=11;} else if(['K','Q','J'].includes(c.v)){sum+=10;} else sum+=c.v; });
        while(sum>21 && aces){ sum-=10; aces--; } return sum; }
      function draw(hand,div){ const card=deck.pop(); hand.push(card); const el=document.createElement('div'); el.innerText=`${card.v}${card.s}`; div.appendChild(el); }
      function endGame(){ const p=score(playerHand), d=score(dealerHand); resultDiv.innerText = p>21?'Has perdido!': d>21||p>d?'¬°Ganaste!':'Has perdido!'; hitBtn.disabled=standBtn.disabled=true;
        if(resultDiv.innerText.includes('Ganaste')) gameBalance+=parseInt(betIn.value); else gameBalance-=parseInt(betIn.value); gameBalSpan.innerText=gameBalance; }
      betBtn.onclick=()=>{
        if(parseInt(betIn.value)>gameBalance){ alert('Fondos PBJ insuficientes'); return; }
        initDeck(); playerHand=[]; dealerHand=[]; playerCardsDiv.innerHTML=''; dealerCardsDiv.innerHTML=''; resultDiv.innerText='';
        draw(playerHand,playerCardsDiv); draw(dealerHand,dealerCardsDiv); draw(playerHand,playerCardsDiv); draw(dealerHand,dealerCardsDiv);
        playerScoreSpan.innerText=score(playerHand); dealerScoreSpan.innerText=score(dealerHand);
        hitBtn.disabled=standBtn.disabled=false;
      };
      hitBtn.onclick=()=>{ draw(playerHand,playerCardsDiv); playerScoreSpan.innerText=score(playerHand); if(score(playerHand)>21) endGame(); };
      standBtn.onclick=()=>{ while(score(dealerHand)<17){ draw(dealerHand,dealerCardsDiv); dealerScoreSpan.innerText=score(dealerHand);} endGame(); };
    </script>
  </body>
</html>
