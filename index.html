<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pepe Blackjack (PBJ) - DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
      body { font-family: 'Press Start 2P', cursive; }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-6 space-y-8">
      <!-- Header -->
      <header class="flex justify-between items-center py-4 border-b border-gray-700">
        <h1 class="text-3xl font-bold text-teal-400">Pepe Blackjack (PBJ)</h1>
        <button id="connectButton" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded">Conectar Wallet</button>
      </header>
      <div id="status" class="text-center text-xs text-gray-400"></div>

      <!-- Saldo y Compra -->
      <section class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl text-teal-300 mb-4">üí∞ Saldo y Compra de Tokens</h2>
        <div class="flex justify-between text-sm mb-2">
          <div>ETH: <span id="ethBalance">-</span></div>
          <div>PBJ: <span id="pbjBalance">-</span></div>
        </div>
        <div class="flex gap-2 mb-4 text-sm">
          <input type="number" id="ethAmount" placeholder="ETH" min="0.01" step="0.01" class="flex-1 p-2 rounded bg-gray-700 text-gray-100" />
          <div class="p-2 bg-gray-700 rounded flex-1 text-center text-gray-100" id="pbjEstimate">0 PBJ</div>
        </div>
        <button id="buyButton" disabled class="w-full bg-teal-600 hover:bg-teal-500 py-2 rounded">Comprar PBJ</button>
      </section>

      <!-- Blackjack Game Container -->
      <section id="blackjackGame" class="bg-gray-800 p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl text-teal-300 mb-4">üÉè Blackjack en Pepe Casino</h2>
        <div class="flex flex-col md:flex-row md:space-x-6">
          <!-- Game Info -->
          <div class="md:w-1/3 space-y-4 text-sm">
            <div>Saldo PBJ: <span id="gameBalance">0</span></div>
            <div class="flex items-center space-x-2">
              <label for="betAmount">Apuesta (PBJ):</label>
              <input type="number" id="betAmount" min="1" step="1" value="100" class="w-24 p-2 rounded bg-gray-700 text-gray-100" />
            </div>
            <div class="flex space-x-2">
              <button id="betButton" class="flex-1 bg-teal-600 hover:bg-teal-500 py-2 rounded">Apostar</button>
              <button id="hitButton" disabled class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded">Pedir Carta</button>
              <button id="standButton" disabled class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded">Plantarse</button>
            </div>
            <div id="message" class="text-sm text-gray-400"></div>
          </div>
          <!-- Cards Display -->
          <div class="md:w-2/3">
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-gray-700 p-4 rounded">
                <h3 class="font-bold text-teal-200 mb-2">Crupier</h3>
                <div id="dealerCards" class="flex flex-wrap gap-1 mb-2"></div>
                <div>Puntos: <span id="dealerScore">0</span></div>
              </div>
              <div class="bg-gray-700 p-4 rounded">
                <h3 class="font-bold text-teal-200 mb-2">Jugador</h3>
                <div id="playerCards" class="flex flex-wrap gap-1 mb-2"></div>
                <div>Puntos: <span id="playerScore">0</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Other sections omitted -->
    </div>

    <script>
      // Ethers.js & Token
      const contractAddr = '0x3Bcc79d679d900b78684f44ff7dacc286fab0c57';
      const tokenAbi = ['function buyTokens() payable','function balanceOf(address)view returns(uint256)'];
      const rate = 1000000;
      let provider, signer, contract;

      // UI Elements
      const connectBtn = document.getElementById('connectButton');
      const statusDiv = document.getElementById('status');
      const ethBalSpan = document.getElementById('ethBalance');
      const pbjBalSpan = document.getElementById('pbjBalance');
      const ethIn = document.getElementById('ethAmount');
      const pbjEst = document.getElementById('pbjEstimate');
      const buyBtn = document.getElementById('buyButton');

      const gameBalSpan = document.getElementById('gameBalance');
      const betIn = document.getElementById('betAmount');
      const betBtn = document.getElementById('betButton');
      const hitBtn = document.getElementById('hitButton');
      const standBtn = document.getElementById('standButton');
      const msgDiv = document.getElementById('message');
      const dealerCardsDiv = document.getElementById('dealerCards');
      const playerCardsDiv = document.getElementById('playerCards');
      const dealerScoreSpan = document.getElementById('dealerScore');
      const playerScoreSpan = document.getElementById('playerScore');

      let userAddr, gameBalance;
      let deck, dealerHand, playerHand;

      // Connect Wallet
      connectBtn.onclick = async () => {
        if (!window.ethereum) return statusDiv.innerText = 'Instala MetaMask';
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        userAddr = await signer.getAddress();
        contract = new ethers.Contract(contractAddr, tokenAbi, signer);
        const ethBal = await provider.getBalance(userAddr);
        const pbjBal = await contract.balanceOf(userAddr);
        ethBalSpan.innerText = `${parseFloat(ethers.utils.formatEther(ethBal)).toFixed(4)} ETH`;
        pbjBalSpan.innerText = `${ethers.utils.formatUnits(pbjBal, 18)} PBJ`;
        gameBalance = parseInt(ethers.utils.formatUnits(pbjBal, 18));
        gameBalSpan.innerText = gameBalance;
        statusDiv.innerText = '‚úÖ Wallet conectada';
        buyBtn.disabled = false;
      };

      // Token purchase estimate
      ethIn.oninput = () => pbjEst.innerText = `${(parseFloat(ethIn.value) || 0) * rate} PBJ`;
      buyBtn.onclick = async () => {
        const val = ethers.utils.parseEther((parseFloat(ethIn.value)||0).toString());
        statusDiv.innerText = 'Confirma en MetaMask';
        const tx = await contract.buyTokens({ value: val }); await tx.wait();
        statusDiv.innerText = '‚úÖ Compra exitosa';
      };

      // Blackjack logic
      const suits = ['‚ô†Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','‚ô£Ô∏è'];
      const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      function createDeck() {
        deck = [];
        suits.forEach(s => values.forEach(v => deck.push({s,v}))); deck.sort(() => Math.random()-0.5);
      }
      function dealCard(hand) { const c=deck.pop(); hand.push(c); return c; }
      function displayHand(hand, container, scoreSpan) {
        container.innerHTML=''; hand.forEach(c=>{
          const d=document.createElement('div'); d.className='p-1 bg-gray-700 rounded text-sm'; d.innerText=`${c.v}${c.s}`; container.appendChild(d);
        }); scoreSpan.innerText=calculateScore(hand);
      }
      function calculateScore(hand) {
        let sum=0, aces=0;
        hand.forEach(c=>{ if(c.v==='A'){aces++;sum+=11;} else if(['J','Q','K'].includes(c.v)) sum+=10; else sum+=parseInt(c.v);} );
        while(sum>21&&aces>0){sum-=10;aces--;} return sum;
      }
      function startGame(){ const bet=parseInt(betIn.value)||0; if(bet>gameBalance)return alert('Fondos insuficientes'); gameBalance-=bet; gameBalSpan.innerText=gameBalance; dealerHand=[];playerHand=[]; createDeck(); dealCard(dealerHand);dealCard(playerHand);dealCard(playerHand); displayHand(dealerHand,dealerCardsDiv,dealerScoreSpan); displayHand(playerHand,playerCardsDiv,playerScoreSpan); hitBtn.disabled=standBtn.disabled=false;betBtn.disabled=true;msgDiv.innerText=''; }
      function hit(){ dealCard(playerHand); displayHand(playerHand,playerCardsDiv,playerScoreSpan); if(calculateScore(playerHand)>21)endGame(); }
      function stand(){ while(calculateScore(dealerHand)<17)dealCard(dealerHand); displayHand(dealerHand,dealerCardsDiv,dealerScoreSpan); endGame(); }
      function endGame(){ const p=calculateScore(playerHand),d=calculateScore(dealerHand); let res='Empate'; if(p>21)res='Perdiste'; else if(d>21||p>d){res='Ganaste'; gameBalance+=parseInt(betIn.value)*2;} msgDiv.innerText=res; gameBalSpan.innerText=gameBalance; hitBtn.disabled=standBtn.disabled=true; betBtn.disabled=false; }
      betBtn.onclick=startGame; hitBtn.onclick=hit; standBtn.onclick=stand;
    </script>
  </body>
</html>
